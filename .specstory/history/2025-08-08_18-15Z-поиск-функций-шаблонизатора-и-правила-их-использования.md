<!-- Generated by SpecStory -->

# Поиск функций шаблонизатора и правила их использования (2025-08-08 18:15Z)

_**User**_

в этом проекте шаблонизатора есть функции которые можно использовать внутри шаблонов chunkStart chunkEnd partial slot content их давай найдем все такие функции и подготовим правила их использования
в качестве референса нужно использовать код проекта и можно использовать шаблоны *.njs из папок /Users/vedmalex/work/grainjs-prod/apps/grainjs/generators_new /Users/vedmalex/work/grainjs-prod/apps/grainjs/generators

правила и примеры нужно сохранить в USAGE.md в корне проекта

---

_**Assistant**_

<think><details><summary>Thought Process</summary>**Searching codebase for functions**

I'm planning to search the codebase for specific names, but the guidance suggests using `codebase_search` instead of `grep_search`. The `codebase_search` tool exists for searching within the repository, but it seems limited to the current workspace for target directories. For external paths, I can use `read_file`, `list_dir`, or `grep` on absolute paths. I'll also run parallel grep searches to find definitions or usages of functions like `chunkStart` specifically in the `.njs` templates.
**Planning function search**

I believe the functions may belong to the template runtime API of fte.js-templates, particularly in files like `MainTemplate.njs`. My plan is to fetch rules by reading MUST_HAVE.md, PRIORITIES.md, and README.md first. After that, I’ll search the codebase for definitions and exports of `chunkStart`, `chunkEnd`, and related functions using `codebase_search` and `grep`. 

I'll also check the usage of these helpers in the templates and external directories. Finally, I’ll synthesize the rules into a USAGE.md file, ensuring to write the text in Russian and comments in English with the specified formatting!
**Managing markdown checks**

I’m considering that we might not need lints for markdown files, especially since the linter_errors spec suggests running `read_lints` only on edited files. It seems like skipping the lints for markdown could save time since they might not be set up. I’ll ensure to follow the "tool_calling" guidelines by providing status updates before making batch calls and use parallel tool calls for reading multiple files. 

First, I’ll read MUST_HAVE.md, PRIORITIES.md, and README.md in a single batch.</details></think>

---

Коротко: сначала загружу проектные правила и руководство, затем найду и проанализирую функции помощники в коде и шаблонах, включая внешние референсы, параллельно. После этого подготовлю `USAGE.md` на русском с примерами использования.

Сначала считываю ключевые проектные документы.

---

Read file: undefined

---

<think><details><summary>Thought Process</summary>**Planning the task**

Alright, I’m laying out my plan: first, I’ll read PRIORITIES.md and README.md. Then, I’ll search the codebase for helper functions and grep across the project for chunkStart and similar items. Next, I want to list and read templates in packages/fte.js-templates/templates/*.njs to see how they utilize those helpers. After that, I’ll check external directories for .njs files. Finally, I’ll derive the documentation and write USAGE.md. Let’s kick off this batch of tool usage to read the necessary files!</details></think>

---

Провожу обзор проекта и ищу в коде и шаблонах упоминания и реализации `chunkStart`, `chunkEnd`, `partial`, `slot`, `content`, включая внешние референсы. Выполню все поиски параллельно.

---

Read file: undefined

---

Read file: undefined

---

<details>
                <summary>Searched codebase "Where are template helper functions like chunkStart, chunkEnd, partial, slot, content defined and how are they used?" • **14** results</summary>
            
| File | Lines |
|------|-------|
| `packages/fte.js-templates/templates/MainTemplate.njs` | Lundefined-74 |
| `packages/fte.js-templates/src/MainTemplate.njs.ts` | L16-445 |
| `packages/fte.js-templates/src/MainTemplate.ts.njs.ts` | Lundefined-364 |
| `packages/fte.js-templates/src.compare/MainTemplate.njs.ts` | Lundefined-405 |
| `packages/fte.js-templates/src.compare/MainTemplate.ts.njs.ts` | Lundefined-410 |
| `demo/indent/main/MainTemplate.njs.js` | L143-192 |
| `packages/fte.js-templates/src.backup.before-regeneration/MainTemplate.njs.ts` | L15-384 |
| `packages/fte.js-templates/dist/MainTemplate.ts.njs.js` | L277-318 |
| `packages/fte.js-templates/templates/MainTemplate.njs` | L66-137 |
| `packages/fte.js-templates/src.backup.before-regeneration/MainTemplate.ts.njs.ts` | Lundefined-336 |
| `demo/chunks/raw/index.njs.js` | Lundefined-59 |
| `packages/fte.js-templates/templates/MainTemplate.njs` | L134-172 |
| `packages/fte.js-templates/templates/MainTemplate.njs` | L169-234 |
| `packages/fte.js-templates/src/MainTemplate.njs.ts` | L11-445 |

</details>

---



---

<details>
            <summary>Listed directory undefined • **0** results</summary>
        
No results found
</details>

---

<details>
            <summary>Listed directory undefined • **0** results</summary>
        
No results found
</details>

---

<details>
            <summary>Listed directory undefined • **0** results</summary>
        
No results found
</details>

---



---

Коротко: провожу параллельный обзор исходных шаблонов (`MainTemplate*.njs`, `codeblock.njs`) и поиск по внешним референсам (`grainjs`), а также ищу определения рантайма `partial/slot/content` для корректных правил.

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---



---



---

<details>
                <summary>Searched codebase "Where are partial, slot and content implemented at runtime and how do they behave?" • **12** results</summary>
            
| File | Lines |
|------|-------|
| `packages/fte.js-base/src/TemplateFactoryBase.ts` | L17-191 |
| `packages/fte.js-templates/src/MainTemplate.njs.ts` | L16-445 |
| `packages/fte.js-templates/src/MainTemplate.ts.njs.ts` | Lundefined-364 |
| `packages/fte.js-base/dist/TemplateFactoryBase.js` | L3-161 |
| `packages/fte.js-base/src/types/BlockContent.ts` | Lundefined-14 |
| `packages/fte.js/src/TemplateFactory.ts` | L6-213 |
| `demo/simple/dist/common/factory.js` | L7-175 |
| `packages/fte.js-browser/src/TemplateFactoryBrowser.ts` | Lundefined-33 |
| `packages/fte.js-templates/dist/MainTemplate.njs.js` | L101-225 |
| `packages/fte.js-templates/templates/MainTemplate.njs` | L169-234 |
| `packages/fte.js-templates/src.backup.before-regeneration/MainTemplate.njs.ts` | L15-384 |
| `packages/fte.js-standalone/src/TemplateFactoryStandalone.ts` | Lundefined-62 |

</details>

---

<think><details><summary>Thought Process</summary>**Applying changes and including references**

I'm moving forward with the plan to apply a patch for adding the `USAGE.md` file because the doc file won't include a linter. I'll also make sure to reference `fte.js-base TemplateFactoryBase.ts` since it’s necessary for including definitions. It’ll be important to read that file thoroughly to define the partial function correctly. I don’t want to miss anything that could affect the implementation!</details></think>

---

Делаю обзор реализаций рантайма функций `partial`, `slot`, `content` и логики `chunkStart/chunkEnd` в исходниках, затем подготовлю и сохраню `USAGE.md`.

---

Read file: undefined

---

<think><details><summary>Thought Process</summary>I'm considering that the document needs to be in Russian while the code and comments should be in English. I’ll use the edit tool to implement the file. It's also important to gather more information about slot usage to ensure I provide accurate guidelines. I’ll look for instances of `slot(` in grainjs templates to gain a better understanding of how that works. This will help me clarify everything effectively!</details></think>

---

Соберу дополнительные примеры использования `slot` и другие вызовы из проекта и внешних шаблонов, затем создам файл `USAGE.md` в корне репозитория с правилами и примерами.

---



---



---

Соберу и сохраню руководство в `USAGE.md` с правилами и примерами использования `chunkStart`, `chunkEnd`, `partial`, `slot`, `content`.

---



---



---

Состояние: нашёл реализации и использования `partial`, `content`, `slot` и механики чанков `chunkStart/chunkEnd` в проекте и в референсах `grainjs`. Подготовил и сохранил руководство.

Что сделал:
- Обнаружил:
  - `partial/content/slot` реализованы в рантайме `packages/fte.js-base/src/TemplateFactoryBase.ts` (`blockContent`).
  - Логика чанков и переопределение `partial` генерируются в `packages/fte.js-templates/templates/MainTemplate.njs` блоки `chunks-start`/`chunks-finish`.
  - Примеры использования слотов и чанков есть в `packages/fte.js-parser/src/__tests__/parser.test.ts`, `demo/slots/*.njs`, а также во внешних `grainjs` генераторах.
- Создал `USAGE.md` с правилами и примерами, учитывая поведение в чанковом режиме.

Ключевые моменты:
- partial(obj, name): подключает шаблон; в чанковом режиме может сливать возвращаемые чанки дочернего шаблона.
- content(blockName, ctx?): выполняет именованный блок текущего/родительского шаблона.
- slot(name, content?): аккумулирует значения по имени; при выводе `#{slot(name)}` делегирует `partial(context[name] || [], name)`.
- chunkStart(name)/chunkEnd(): используютcя при активной директиве `chunks`; управляют многофайловым выводом.

Файл обновлён:
- `USAGE.md` в корне проекта с краткими правилами и примерами использования.

---

_**User**_

давай так же дополним файл правилами использования всех директив 

---

_**Assistant**_

<think><details><summary>Thought Process</summary>**Searching project files**

I'm planning to run a grep search across the project files for `<#@ ` to locate where it’s used. This should help me find any relevant occurrences. Additionally, I think I should also look into the parser to see which directives are allowed during lexing. Gathering this information will give me a clearer idea of how the project is set up. Let's see what I can uncover!</details></think>

---

Собираю список всех директив, поддерживаемых шаблонизатором, из исходников и шаблонов, чтобы добавить их правила использования в `USAGE.md`. Выполню поиски по шаблонам и парсеру параллельно.

---



---



---



---



---



---



---



---



---



---

Read file: undefined

---

<think><details><summary>Thought Process</summary>**Updating directive documentation**

I need to update USAGE.md to include rules for all directives we've identified in the parser, like extend, context, alias, and others. Although block/slot syntax isn’t technically directives, the user asked for "правила использования всех директив", so I’ll focus on <#@ ... #> directives. I’ll add descriptions, syntax, effects, interactions, and examples. Since we're editing code/files, I’ll keep formatting minimal and use apply_patch to update USAGE.md by appending a section for "Директивы."
**Clarifying directive functionalities**

I need to explain several directives based on the code. For example, the "extend" directive sets `directives.extend`, affecting `MainTemplate` to set parent and mergeParent, which impacts content fallbacks. The "context" directive defines the default parameter name for generated scripts. The "alias" directive assigns template alias names included in `MainTemplate.njs` or TS. The "deindent" option applies indentation removal and can take an optional numeric parameter. Lastly, "chunks" activates chunk mode and sets the main chunk name, including interplay with flags like includeMainChunk and useHash.
**Explaining directive behaviors**

I need to provide examples for `chunkStart` and `chunkEnd`. 

The `includeMainChunk` directive plays a role in determining if a chunk will be included or filtered in the finish logic. 

For `useHash`, it affects whether output is mapped as an object or an array. 

The `noContent` directive disables content generation for the helper, making the content property false, which means no content will be injected. This also affects checks in the code, resulting in calling content returning undefined.

For `noSlots`, it alters the initial content in directives to set `slots = true` or `false`. This is more about parser semantics and isn't typically used by MainTemplate, but we can document its advisory nature based on user requests.
**Discussing directive flags**

I should mention that the flags `noSlots`, `noBlocks`, `noPartial`, and `noOptions` toggle some meta aspects and aren’t currently consumed by templates or internal functions. However, they are set by the parser. 

Now, I wonder where these flags are actually used. I think it would be helpful to search for `noSlots` specifically to see if I can find any relevant instances or documentation surrounding its use. That way, I'll have a clearer understanding of its application.</details></think>

---



---



---



---

<think><details><summary>Thought Process</summary>**Considering escaping directives**

I’m pondering how CodeBlockDirectives handles unknown directives like `noEscape`. It seems that the `textQuote` logic in codeblock.njs might have some influence here. There’s a distinction in ejs tags between `#{}` and `!{}` for escaping, and `noEscape` could be an older directive intended for raw outputs. However, it doesn’t look like CodeBlockDirectives processes it, even though snapshots do include it in tests. I should document both `noEscape` and `noIndent` if they exist.
**Examining directives and slots**

If the runtime is ignoring certain directives, it makes sense to mark them as "не поддерживается/игнорируется" for the current engine to accurately reflect the code. We have the 'alias' directive variant without parameters in the `import-from-ra-ui-components.njs`. Interestingly, this alias can be multiple lines and support one or more values. There's also the 'requireAs' directive, which has two parameters and is widely used. Plus, I’m noticing the 'slot' block's constructs in the parser. Documentation on these would be helpful!
**Clarifying directives and aliases**

I'm reflecting on the structure of `end` and `slot ... end`. These aren’t directives but rather block constructs. The user asked for rules regarding all directive usages within files, which means I need to focus on those starting with `<#@ ... #>`. I’ll document the recognized directives like extend, context, alias, and others, including noting `noEscape` and `noIndent` as obsolete. It's interesting how `aliases` appear differently in TS and JS versions. I need to clarify how `tpl.aliases` is set in both versions, too.
**Reviewing alias and requireAs functionality**

I’m examining the `MainTemplate.njs` file and seeing that it sets `this.aliases={}` when `requireAs` is present. However, the alias directive appears to assign `this.alias` using `JSON.stringify(directives.alias)` instead of `aliases`. In `TemplateFactoryBase.register`, there's a check to cache templates under each alias. It's clear that the alias directive contributes to an alias array property, while `requireAs` creates a mapping for `this.aliases`. I should document directive usage, including syntax and examples, and update the `USAGE.md` file accordingly.
**Updating the USAGE.md**

I noticed we haven't checked the content of USAGE.md yet, but it's essential to open it for context before making edits. I can append new content regarding directives using `apply_patch` for a clean unified diff. Each directive needs detailed explanations, so I’ll include information about how `extend`, `context`, and `alias` work, along with examples. I want to address `noContent`, `noSlots`, and the rest, marking them as reserved or deprecated when applicable. After gathering all this information, I’ll implement the changes to create a "Директивы" section in the document.</details></think>

---

Добавлю раздел с правилами всех директив в `USAGE.md`, основанный на текущем парсере (`packages/fte.js-parser/src/index.ts`) и реальных шаблонах. Затем проверю линтер.

---



---



---

Готово. Я дополнил `USAGE.md` разделом о директивах:

- Добавлены правила и синтаксис: `extend`, `context`, `alias`, `requireAs`, `deindent`, `chunks` (+ `includeMainChunk`, `useHash`), флаги `noContent`, `noSlots`, `noBlocks`, `noPartial`, `noOptions`, а также `promise`, `callback`.
- Указал статус и фактическое влияние флагов (что реально используется в `MainTemplate.*`, что распознаётся парсером, но сейчас не влияет).
- Описал «прочие» (`noEscape`, `noIndent`) как встречающиеся в демо, но не обрабатываемые парсером.
- Добавил сводку по структурным тегам: `block`, `slot` (блочный), `end`.

Теперь в `USAGE.md` есть единое руководство по функциям и директивам с примерами, опирающееся на код парсера и шаблонов.

---

_**User**_

так же в options так же есть функции, который можно использовать, давай добавим и их описание тоже 

---

_**Assistant**_



---



---



---

<details>
                <summary>Searched codebase "What functions and fields does options provide to templates (escapeIt, applyIndent, applyDeindent, sourceMap options)? Where are DefaultFactoryOptions defined?" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `packages/fte.js-base/src/types/DefaultFactoryOption.ts` | Lundefined-12 |
| `packages/fte.js-base/src/types/DefaultFactoryOptions.ts` | Lundefined-12 |
| `packages/fte.js-base/dist/types/DefaultFactoryOption.d.ts` | Lundefined-10 |
| `packages/fte.js-base/dist/types/DefaultFactoryOptions.d.ts` | Lundefined-9 |
| `packages/fte.js-base/dist/types/DefaultFactoryOptions.js` | Lundefined-13 |
| `packages/fte.js-templates/src/MainTemplate.njs.ts` | Lundefined-16 |
| `packages/fte.js-templates/src/index.ts` | Lundefined-33 |
| `packages/fte.js-templates/dist/index.d.ts` | Lundefined-12 |
| `packages/fte.js-templates/src.compare/MainTemplate.njs.ts` | Lundefined-405 |
| `packages/fte.js-templates/dist/MainTemplate.njs.d.ts` | Lundefined-13 |
| `packages/fte.js-templates/src.compare/MainTemplate.ts.njs.ts` | Lundefined-410 |
| `packages/fte.js-templates/src/codeblock.njs.ts` | Lundefined-244 |
| `packages/fte.js-templates/src.backup.before-regeneration/MainTemplate.njs.ts` | Lundefined-15 |
| `demo/simple/dist/common/interfaces.d.ts` | Lundefined-10 |
| `packages/fte.js-templates/src/MainTemplate.njs.ts` | L11-445 |

</details>

---



---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---



---

Read file: undefined

---



---



---

Добавил в `USAGE.md` раздел про объект options:

- Описал функции:
  - escapeIt(text): экранирование спецсимволов.
  - applyIndent(str, indent): добавление отступа.
  - applyDeindent(str, numChars): снятие общего отступа.
- Описал sourcemap-поля: sourceMap, inline, sourceRoot, sourceFile.
- Добавил минимальные примеры использования в шаблонах.

Все основано на `packages/fte.js-base/src/types/DefaultFactoryOption.ts` и утилитах `escapeIt`, `applyIndent`, `applyDeindent`.

---

