# Задача: Исследование и исправление регрессии генерации шаблонов в fte.js-templates

## Контекст

Команда `bun ./packages/fte.js/bin/fte.js bundle packages/fte.js-templates/templates packages/fte.js-templates/src --typescript` перестала работать после обновления шаблонов. Новая реализация ожидает от `.njs`-файлов определенной структуры (`context.directives`, `blocks`, `slots`) и некорректно обрабатывает возвращаемые значения от `partial(..., 'core')`.

## Детальный анализ несоответствий

| Аспект | Старая реализация (`src.backup.before-regeneration`) | Новая реализация (`src`) | Проблема |
| :--- | :--- | :--- | :--- |
| **Возвращаемое значение `partial`** | Всегда `string` (текст шаблона). | `object` вида `{ code, map }` для поддержки sourcemaps. | Вызывающие шаблоны не готовы к объекту и вставляют в код `[object Object]`. |
| **Зависимость от `context.directives`** | Минимальная. Шаблоны работали даже при `undefined`. | Жесткая. Код обращается к `context.directives.chunks` без проверки на существование. | `TypeError` на простых шаблонах, где директивы не определены. |
| **Обработка `return`** | Не вставляла `return` на верхний уровень модуля. | Некоторые шаблоны генерируют верхнеуровневые `return`. | Ошибка компиляции SWC: `Return statement is not allowed here`. |
| **Асинхронность** | Отсутствовала. Весь код был синхронным. | Добавлена поддержка `async` через `options.promise` и хелперы `__then`. | Усложнение логики, которое способствует ошибкам при обработке значений. |
| **Sourcemaps** | Базовая поддержка. | Расширенная, с более гранулярным маппингом. | Является первопричиной возврата объекта вместо строки, что ломает совместимость. |

## Заключение анализа

Регрессия вызвана нарушением контракта между шаблонами. `codeblock.njs.ts` и другие внутренние шаблоны были обновлены для поддержки sourcemaps и асинхронности, но внешние шаблоны, которые их используют, не были адаптированы к новым форматам возвращаемых данных и новым ожиданиям по структуре контекста.
