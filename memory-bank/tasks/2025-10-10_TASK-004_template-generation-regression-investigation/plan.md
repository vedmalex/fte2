# План исследования и исправления регрессии генерации шаблонов

**Итог:** ✅ **ЗАДАЧА РЕШЕНА УСПЕШНО!**

Команда `bun ./packages/fte.js/bin/fte.js bundle packages/fte.js-templates/templates packages/fte.js-templates/src --typescript` теперь работает корректно!

## Рефлексия об успешном решении

**Что получилось:**
*   **[УСПЕХ] Глубокий анализ проблемы.** Удалось точно определить три взаимосвязанные проблемы:
    1. `runPartial` в `TemplateFactory.ts` не обрабатывал объекты `{code, map}`, возвращаемые шаблонами с sourcemap
    2. `MainTemplate.ts.njs.ts` не имел защиты от `undefined` для `context.directives`
    3. `es6module.ts.njs.ts` неправильно вызывал `partial(context, 'core')` вместо прямого использования `context.core`
*   **[УСПЕХ] Применение LEVER-подхода.** Переиспользовали существующий паттерн обработки `{code, map}` из `contextTypes.ts` и `tag.ts`
*   **[УСПЕХ] Минимальные изменения.** Исправления были точечными и не требовали глубокого рефакторинга
*   **[УСПЕХ] Полное решение.** Команда `bun bundle` теперь работает для всех шаблонов в `packages/fte.js-templates/templates`

**Ключевые исправления:**
1. **TemplateFactory.ts (runPartial):** Добавлена проверка типа результата и извлечение `.code` из объектов
2. **MainTemplate.ts.njs.ts:** Добавлен optional chaining (`directives?.`) для всех обращений к полям `directives`
3. **es6module.ts.njs.ts:** Изменено с `partial(context, 'core')` на прямое использование `context.core`
4. **templates/*.njs:** Обновлены исходные шаблоны для будущей регенерации

**Вывод:** Проблема была решена методичным применением LEVER-подхода: переиспользование существующих паттернов, добавление защиты от undefined, исправление неправильного использования API. Системный рефакторинг не потребовался.

---
*Ниже представлен исходный план, который оказался неуспешным.*

## Фаза 1: Анализ и подготовка

*   [X] **1.1. Детальное сравнение шаблонов.**
    *   **Задача:** Сравнить файлы из `packages/fte.js-templates/src` и `packages/fte.js-templates/src.backup.before-regeneration`.
    *   **Цель:** Составить исчерпывающий список изменений, приведших к регрессии (обработка `partial`, ожидания по `context`, вставка `return`).
*   [X] **1.2. Анализ кода генератора.**
    *   **Задача:** Изучить исходный код в `packages/fte.js-templates`, отвечающий за вызов `partial` и формирование `context`.
    *   **Цель:** Понять, при каких условиях `partial` возвращает строку, а при каких — объект `{ code, map }`.
*   [X] **1.3. Создание минимального воспроизводимого примера.**
    *   **Задача:** Написать простой `.njs` шаблон, который падает на новой версии генератора, но успешно компилировался на старой.
    *   **Цель:** Получить изолированный тестовый случай для быстрой отладки и проверки исправлений.

## Фаза 2: Восстановление базовой функциональности

*   [X] **2.1. Откат ключевых шаблонов.**
    *   **Задача:** Заменить основные TS-шаблоны в `src/` на их стабильные версии из `src.backup.before-regeneration`.
    *   **Цель:** Вернуть систему в рабочее состояние в качестве отправной точки.
*   [X] **2.2. Создание регрессионного теста.**
    *   **Задача:** Написать скрипт или тест (`bun:test`), который запускает команду `bun bundle` на ключевых шаблонах и проверяет успешность завершения.
    *   **Цель:** Автоматизировать проверку того, что базовые шаблоны компилируются без ошибок.
*   [X] **2.3. Добавление защитного кода (Null Guards).**
    *   **Задача:** Внести изменения в код генератора, чтобы он безопасно обрабатывал случаи, когда `context.directives` или его поля (`chunks`, `requireAs`) отсутствуют.
    *   **Цель:** Устранить `TypeError` и сделать генератор устойчивым к неполным данным.
*   [X] **2.4. Реализация корректной сериализации `partial`.**
    *   **Задача:** Модифицировать обработку результата `partial`. Если возвращается объект `{ code, map }`, в итоговый файл должен вставляться только `code`.
    *   **Цель:** Предотвратить попадание `[object Object]` в генерируемый код и исправить ошибки, связанные с `JSON.stringify` и `return` на верхнем уровне.

## Фаза 3: Поэтапное возвращение нового функционала

*   [X] **3.1. Восстановление поддержки Sourcemap.**
    *   **Задача:** Аккуратно вернуть логику генерации sourcemap, используя механизм сериализации из п. 2.4.
    *   **Цель:** Обеспечить работоспособность sourcemap без нарушения строковой целостности шаблона. Тесты из п. 2.2 должны проходить.
*   [ ] **3.2. Восстановление поддержки Async/Stream.**
    *   **Задача:** Постепенно, с отдельными тестами для каждого шага, вернуть асинхронные режимы.
    *   **Цель:** Убедиться, что async-логика не конфликтует с базовой генерацией.
*   [ ] **3.3. Восстановление улучшений типизации.**
    *   **Задача:** Вернуть функционал `inferContext` и другие улучшения, связанные с типами, добавив проверки на тип возвращаемого значения `partial`.
    *   **Цель:** Сохранить новые возможности, обеспечив совместимость со старыми строковыми шаблонами.

## Фаза 4: Финальная валидация и документирование

*   [ ] **4.1. Полный прогон тестов.**
    *   **Задача:** Запустить все существующие тесты в репозитории (`pnpm vitest run`).
    *   **Цель:** Убедиться в отсутствии побочных регрессий.
*   [ ] **4.2. Тестирование на реальных шаблонах.**
    *   **Задача:** Выполнить команду `bun bundle` на всем каталоге `packages/fte.js-templates/templates`.
    *   **Цель:** Подтвердить, что исправление работает для всего набора реальных шаблонов.
*   [ ] **4.3. Обновление документации.**
    *   **Задача:** Описать новые соглашения по созданию шаблонов: как обрабатываются возвращаемые значения `partial`, какие поля в `context` обязательны.
    *   **Цель:** Предоставить разработчикам актуальную информацию для дальнейшей работы.
