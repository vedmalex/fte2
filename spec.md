Техническое задание: исследование регрессии генерации шаблонов в fte.js-templates

  - Контекст: В ветке master репозитория /Users/vedmalex/work/fte2 команда bun ./packages/fte.js/bin/fte.js bundle packages/fte.js-templates/
    templates packages/fte.js-templates/src --typescript перестала завершаться успешно.
  - Суть проблемы: После миграции юнит‑тестов на Vitest и обновления шаблонов TypeScript (MainTemplate.ts.njs, es6module.ts.njs,
    singlefile.ts.njs, standalone*.ts.njs) генератор рассчитывает, что входные .njs содержат полностью заполненные context.directives/blocks/
    slots, а partial(...,'core') всегда возвращает строку. Реальные шаблоны (особенно из каталога templates/) не удовлетворяют этим условиям:
      - context.directives бывает undefined ⇒ TypeError (directives.chunks).
      - partial(...,'core') возвращает { code, map } ⇒ в итоговый файл попадает [object Object].
      - Обработчики вставляют верхнеуровневые return в сгенерированный TS‑модуль ⇒ SWC сообщает “Return statement is not allowed here”.
  - Что работает в предыдущей версии: В каталоге packages/fte.js-templates/src.backup.before-regeneration лежит стабильная ревизия. Там
    шаблоны формируют вывод строками, не зависят от directives и не используют sourcemap‑опции; partial всегда инлайнится как текст, и сборка
    выполнялась без ошибок. Эти базовые шаблоны можно принять за фундамент и дополнять их поддержкой sourcemap/async без изменения основной
    модели генерации.
  - Цель исследования:
      1. Проанализировать текущую генерацию в packages/fte.js-templates/src/*.ts и определить, какие ожидаемые структуры (директивы, блоки,
         возвращаемые значения partial) должны быть обязательными, а какие нужно обрабатывать безопасно.
      2. Сравнить старые шаблоны из src.backup.before-regeneration с текущими и выявить, какие добавления (sourcemap, async, typedef’ы)
         необходимо встраивать поверх устойчивой строковой модели.
      3. Выяснить, как правильно сериализовать результаты partial (особенно { code, map }) в TypeScript‑шаблонах, чтобы итоговый модуль
         собирался, сохранив совместимость со старым поведением.
      4. Сформировать рекомендации, как сохранить новые возможности (sourcemap, async режимы, typedef’ы), не ломая базовые сценарии, и план
         поэтапного обновления шаблонов.
  - Исходные материалы:
      - Рабочая версия шаблонов: packages/fte.js-templates/src.backup.before-regeneration.
      - Текущая сломанная версия: packages/fte.js-templates/src.
      - Заключение о регрессии: fix_conclusion.md.
  - Ожидаемый результат исследования:
      - Детальный перечень несоответствий между старой и новой реализацией.
      - Предложенный дизайн или набор патчей, которые восстановят способность bun templates проходить на реальных шаблонах, не откатывая
        полезные улучшения.
      - План тестирования (в том числе поддержание pnpm vitest run) и критерии приёмки.
  - Дополнительно: Зафиксировать любые предположения по наполнению context.directives, поведению codeblock и взаимодействию со SWC, чтобы
    команда разработки могла использовать выводы для фазового рефакторинга либо точечного фикса.

  Сформулированное ТЗ можно передать команде/разработчику для углублённого анализа и восстановления работоспособности генератора шаблонов.
