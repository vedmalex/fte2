# Управление зависимостями с помощью каталогов в Bun

Каталоги (Catalogs) в Bun предоставляют простой способ для совместного использования общих версий зависимостей между несколькими пакетами в монорепозитории. Вместо того чтобы многократно указывать одни и те же версии в каждом пакете воркспейса, вы определяете их один раз в корневом `package.json` и последовательно ссылаетесь на них во всем проекте.

## Обзор

В отличие от традиционного управления зависимостями, где каждый пакет воркспейса должен независимо указывать версии, каталоги позволяют вам:

1.  **Определять каталоги версий** в корневом `package.json`.
2.  **Ссылаться на эти версии** с помощью простого протокола `catalog:`.
3.  **Обновлять все пакеты одновременно**, изменяя версию всего в одном месте.

Это особенно полезно в больших монорепозиториях, где десятки пакетов должны использовать одну и ту же версию ключевых зависимостей.

## Как использовать каталоги

### Пример структуры директорий

Рассмотрим монорепозиторий со следующей структурой:

```
my-monorepo/
├── package.json
├── bun.lockb
└── packages/
    ├── app/
    │   └── package.json
    ├── ui/
    │   └── package.json
    └── utils/
        └── package.json
```

### 1. Определение каталогов в корневом package.json

В вашем корневом `package.json` добавьте поле `catalog` или `catalogs` внутри объекта `workspaces`:

```json
{
  "name": "my-monorepo",
  "workspaces": {
    "packages": [
      "packages/*"
    ],
    "catalog": {
      "react": "^19.0.0",
      "react-dom": "^19.0.0"
    },
    "catalogs": {
      "testing": {
        "jest": "30.0.0",
        "testing-library": "14.0.0"
      }
    }
  }
}
```

> **Примечание:** Если вы разместите `catalog` или `catalogs` на верхнем уровне файла `package.json` (вне `workspaces`), это также будет работать.

### 2. Ссылки на версии из каталога в пакетах воркспейса

В `package.json` ваших пакетов используйте протокол `catalog:` для ссылки на версии:

**packages/app/package.json**

```json
{
  "name": "app",
  "dependencies": {
    "react": "catalog:",
    "react-dom": "catalog:",
    "jest": "catalog:testing"
  }
}
```

**packages/ui/package.json**

```json
{
  "name": "ui",
  "dependencies": {
    "react": "catalog:",
    "react-dom": "catalog:"
  },
  "devDependencies": {
    "jest": "catalog:testing",
    "testing-library": "catalog:testing"
  }
}
```

### 3. Запуск `bun install`

Выполните `bun install`, чтобы установить все зависимости в соответствии с версиями из каталогов.

## `catalog` в сравнении с `catalogs`

Bun поддерживает два способа определения каталогов:

1.  **`catalog`** (единственное число): Единый каталог по умолчанию для часто используемых зависимостей.

```json
"catalog": {
"react": "^19.0.0",
"react-dom": "^19.0.0"
}
```

    Ссылка на него выполняется просто с помощью `catalog:`:

```json
"dependencies": {
"react": "catalog:"
}
```

2.  **`catalogs`** (множественное число): Несколько именованных каталогов для группировки зависимостей.

```json
"catalogs": {
"testing": {
"jest": "30.0.0"
},
"ui": {
"tailwind": "4.0.0"
}
}
```

    Ссылка выполняется с помощью `catalog:<имя_каталога>`:

    ```json
    "dependencies": {
  "jest": "catalog:testing",
  "tailwind": "catalog:ui"
}
    ```

## Преимущества использования каталогов

-   **Согласованность**: Гарантирует, что все пакеты используют одну и ту же версию критически важных зависимостей.
-   **Простота обслуживания**: Обновляйте версию зависимости в одном месте вместо множества файлов `package.json`.
-   **Ясность**: Сразу видно, какие зависимости стандартизированы во всем монорепозитории.
-   **Простота**: Нет необходимости в сложных стратегиях разрешения версий или внешних инструментах.

## Пример из реальной практики

Вот более полный пример для React-приложения:

**Корневой package.json**

```json
{
  "name": "react-monorepo",
  "workspaces": {
    "packages": [
      "packages/*"
    ],
    "catalog": {
      "react": "^19.0.0",
      "react-dom": "^19.0.0",
      "react-router-dom": "^6.15.0"
    },
    "catalogs": {
      "build": {
        "webpack": "5.88.2",
        "babel": "7.22.10"
      },
      "testing": {
        "jest": "29.6.2",
        "react-testing-library": "14.0.0"
      }
    }
  },
  "devDependencies": {
    "typescript": "5.1.6"
  }
}
```

**packages/app/package.json**

```json
{
  "name": "app",
  "dependencies": {
    "react": "catalog:",
    "react-dom": "catalog:",
    "react-router-dom": "catalog:",
    "@monorepo/ui": "workspace:*",
    "@monorepo/utils": "workspace:*"
  },
  "devDependencies": {
    "webpack": "catalog:build",
    "babel": "catalog:build",
    "jest": "catalog:testing",
    "react-testing-library": "catalog:testing"
  }
}
```

**packages/ui/package.json**

```json
{
  "name": "@monorepo/ui",
  "dependencies": {
    "react": "catalog:",
    "react-dom": "catalog:"
  },
  "devDependencies": {
    "jest": "catalog:testing",
    "react-testing-library": "catalog:testing"
  }
}
```

## Обновление версий

Чтобы обновить версии во всех пакетах, просто измените версию в корневом `package.json`:

```json
"catalog": {
  "react": "^19.1.0", // Обновлено с ^19.0.0
  "react-dom": "^19.1.0" // Обновлено с ^19.0.0
}
```

Затем выполните `bun install`, чтобы обновить все пакеты.

## Интеграция с локфайлом

Локфайл Bun (`bun.lockb`) отслеживает версии из каталогов, обеспечивая согласованные установки в различных средах. Он включает в себя:

-   Определения каталогов из вашего `package.json`.
-   Разрешенные (конкретные) версии для каждой зависимости из каталога.

## Ограничения и особые случаи

-   Ссылки на каталоги должны соответствовать зависимости, определенной либо в `catalog`, либо в одном из именованных `catalogs`.
-   Пустые строки и пробелы в именах каталогов игнорируются (рассматриваются как ссылка на каталог по умолчанию).
-   Неверные версии зависимостей в каталогах приведут к ошибке разрешения во время `bun install`.
-   Каталоги доступны только внутри воркспейсов; их нельзя использовать вне монорепозитория.

## Публикация

Когда вы выполняете `bun publish` или `bun pm pack`, Bun автоматически заменяет ссылки `catalog:` в вашем `package.json` на разрешенные номера версий. Опубликованный пакет будет содержать обычные semver-строки и больше не будет зависеть от определений ваших каталогов.
