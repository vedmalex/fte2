## Заключение по регрессии генерации шаблонов

### Что работало в прошлой версии
- Базовые TS‑шаблоны (`MainTemplate.ts.njs`, `es6module.ts.njs`, `singlefile.ts.njs`, `standalone*.ts.njs`) из каталога `src.backup.before-regeneration` формировали вывод исключительно строками.  
- `partial(..., 'core')` всегда инлайнился как текст; возвращаемые объекта/карты не поддерживались, поэтому итоговый файл гарантированно был валидным JS/TS без дополнительных проверок.
- Шаблоны не зависели от расширенных директив (`chunks`, `requireAs`, `contextTypes`) и не требовали sourcemap‑настроек — достаточно было presence `context.main`, `context.blocks`, `context.slots`.

### Что изменилось в новой реализации
- В актуальных файлах из `src/` добавлена поддержка sourcemap/async режимов: `partialOptions` пробрасываются в `codeblock`, внедряются typedef/контекстные типы, появляется ожидание объектов `{ code, map }`.
- Новый код деградирует при пустых директивах: обращение `context.directives.chunks`/`requireAs` происходит без проверок (подразумевается, что парсер всегда заполнил структуру).
- Отдельные шаблоны (например, `es6module.ts.njs`, `singlefile.ts.njs`) пытаются сериализовать результат `partial` целиком (`JSON.stringify` объекта) и/или вставляют верхнеуровневые `return` в сгенерированный модуль. Это приводит к ошибкам SWC (`Expected ',', got 'Object'`, `Return statement is not allowed here`).
- `singlefile.ts.njs` теперь стремится сохранять типовую информацию (`inferContext`), но всё ещё рассчитывает, что `partial` вернёт строку; когда приходит `{code,map}`, происходит аварийная вставка `[object Object]`.

### Итог
Регрессия вызвана жесткими ожиданиями новой версии: код генерации не учитывает, что шаблон может:
- не иметь директив вовсе (типичный случай для простых `.njs`);
- возвращать не строку, а объект `{ code, map }` после прохождения через `codeblock`;
- требовать только строковый вывод без верхнеуровневых `return`.

Пока эти сценарии не будут покрыты защитой/постобработкой, команда `bun templates` продолжит падать на реальных шаблонах, хотя старая ревизия из `src.backup.before-regeneration` успешно проходила сборку.

### Предлагаемый путь восстановления
- Взять как основу шаблоны из `src.backup.before-regeneration`, которые гарантированно генерируют валидный JS/TS.
- Поверх них аккуратно добавить поддержку sourcemap/async режимов: проброс `partialOptions`, разворачивание `{ code, map }` и возврат map‑структур без изменения строковой модели.
- После этого, уже на стабильном фундаменте, постепенно переносить дополнительные улучшения (типовая генерация, `inferContext`, обработка `promise/stream`) с обязательными null‑guardами, чтобы за каждый шаг отвечал набор тестов.
